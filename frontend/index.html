<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Practica PayPhone - ULEAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#121b30;
      --card:#0f1730cc;
      --stroke:#263255;
      --text:#eaf0ff;
      --muted:#a9b7e6;
      --accent:#7c3aed;   /* morado */
      --accent2:#22c55e;  /* verde */
      --warn:#f59e0b;     /* ámbar */
      --danger:#ef4444;   /* rojo */
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.25), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:40px 18px;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      display:grid;
      gap:18px;
      grid-template-columns: 1.2fr .8fr;
    }

    @media (max-width: 920px){
      .wrap{grid-template-columns: 1fr;}
    }

    .header{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 18px 22px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      box-shadow: 0 12px 30px rgba(124,58,237,.35);
      display:grid;place-items:center;
      font-weight:800;
    }
    .title{
      display:flex;flex-direction:column;line-height:1.1;
    }
    .title b{font-size:18px}
    .title span{font-size:13px;color:var(--muted)}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,48,.9), rgba(15,23,48,.65));
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      gap:14px;
    }

    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      transition: .2s;
    }
    input:focus{
      border-color: rgba(124,58,237,.8);
      box-shadow: 0 0 0 3px rgba(124,58,237,.15);
    }

    .row2{display:grid; gap:12px; grid-template-columns: 1fr 1fr;}
    @media (max-width:520px){ .row2{grid-template-columns:1fr;} }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top: 4px;}
    button{
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      color: white;
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
    }
    button:active{transform: scale(.99);}
    button:disabled{opacity:.6; cursor:not-allowed;}

    .btnPayphone{
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      box-shadow: 0 12px 25px rgba(124,58,237,.25);
    }
    .btnCard{
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      box-shadow: 0 12px 25px rgba(59,130,246,.25);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--text);
      font-weight: 700;
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .status{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      margin-top: 12px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      margin-top: 5px;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,.12);
    }
    .dot.ok{background: var(--accent2); box-shadow:0 0 0 4px rgba(34,197,94,.12);}
    .dot.bad{background: var(--danger); box-shadow:0 0 0 4px rgba(239,68,68,.12);}
    .status b{display:block; margin-bottom:2px;}
    .status span{color:var(--muted); font-size:12px; line-height:1.35;}

    pre{
      margin:0;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      overflow:auto;
      max-height: 340px;
      font-size: 12px;
      color: #e6eeff;
    }

    a.link{
      color: #a5b4fc;
      text-decoration: none;
      border-bottom: 1px dashed rgba(165,180,252,.6);
    }

    .small{
      font-size:12px;color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">P</div>
        <div class="title">
          <b>Practica PayPhone</b>
          <span>Generación de pago + redirección (ULEAM)</span>
        </div>
      </div>
      <div class="pill" id="envPill">Backend: http://localhost:3001</div>
    </div>

    <!-- FORM -->
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Crear pago</h2>
      <div class="small">Completa los datos y elige cómo pagar.</div>

      <div class="grid" style="margin-top:14px;">
        <div class="row2">
          <div>
            <label for="amount">Monto (USD)</label>
            <input id="amount" type="number" step="0.01" value="1.00" />
          </div>
          <div>
            <label for="reference">Referencia</label>
            <input id="reference" type="text" value="Pago de prueba ULEAM" />
          </div>
        </div>

        <div class="btnRow">
          <button class="btnPayphone" id="btnPayphone">Pagar con PayPhone</button>
          <button class="btnCard" id="btnCard">Pagar con tarjeta</button>
          <button class="btnGhost" id="btnHome" type="button">Ir a inicio</button>
        </div>

        <div class="hint">
          Tip: Si pagas con tarjeta, usa <b>payWithCard</b>. Si pagas con app, usa <b>payWithPayPhone</b>.
          El sistema crea el <i>paymentId</i> en el backend y luego te redirige.
        </div>

        <div class="status" id="statusBox" style="display:none;">
          <div class="dot" id="statusDot"></div>
          <div>
            <b id="statusTitle">Procesando...</b>
            <span id="statusMsg">Generando enlace de pago...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RESPONSE -->
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Respuesta</h2>
      <div class="small">Aquí verás el JSON completo del backend (útil para tu PDF).</div>
      <div style="margin-top:12px;">
        <pre id="out">{ }</pre>
      </div>
      <div class="hint" style="margin-top:10px;">
        Si no redirige, revisa que en <b>responseReceived</b> venga <code>payWithPayPhone</code> y/o <code>payWithCard</code>.
      </div>
    </div>
  </div>

  <script>
    const out = document.getElementById("out");
    const statusBox = document.getElementById("statusBox");
    const statusDot = document.getElementById("statusDot");
    const statusTitle = document.getElementById("statusTitle");
    const statusMsg = document.getElementById("statusMsg");

    const BACKEND = "http://localhost:3001";

    function setStatus(type, title, msg){
      statusBox.style.display = "flex";
      statusDot.className = "dot";
      if(type === "ok") statusDot.classList.add("ok");
      if(type === "bad") statusDot.classList.add("bad");
      statusTitle.textContent = title;
      statusMsg.textContent = msg;
    }

    async function createPaymentAndRedirect(mode){
      // mode: "payphone" | "card"
      try{
        setStatus("warn", "Procesando…", "Generando enlace de pago en PayPhone…");

        const body = {
          amountUSD: Number(document.getElementById("amount").value),
          reference: document.getElementById("reference").value
        };

        const resp = await fetch(`${BACKEND}/api/payphone/prepare`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await resp.json();
        out.textContent = JSON.stringify(data, null, 2);

        const r = data?.responseReceived || {};
        const urlPayphone = r.payWithPayPhone;
        const urlCard = r.payWithCard;

        if(resp.ok){
          setStatus("ok", "Enlace creado ✅", "Redirigiendo al checkout…");
        } else {
          setStatus("bad", "Error ❌", "Revisa el JSON de respuesta.");
          return;
        }

        const redirectUrl = (mode === "payphone") ? urlPayphone : urlCard;

        if(!redirectUrl){
          setStatus("bad", "No llegó la URL", "No existe payWithPayPhone/payWithCard en la respuesta.");
          return;
        }

        // Pequeña pausa para que se vea el status bonito
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 650);

      }catch(err){
        setStatus("bad", "Error interno ❌", String(err));
        out.textContent = JSON.stringify({ error: String(err) }, null, 2);
      }
    }

    document.getElementById("btnPayphone").addEventListener("click", () => {
      createPaymentAndRedirect("payphone");
    });

    document.getElementById("btnCard").addEventListener("click", () => {
      createPaymentAndRedirect("card");
    });

    document.getElementById("btnHome").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
